{% extends "base.html" %}
{% load course_tags %}

{% block title %}{{ course.title }} - LearnHub{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto">
  {% if messages %}
    <div class="mb-4">
        {% for message in messages %}
            <div class="p-4 {% if message.tags == 'success' %}bg-green-100 text-green-700{% elif message.tags == 'error' %}bg-red-100 text-red-700{% else %}bg-blue-100 text-blue-700{% endif %} rounded">
                {{ message }}
            </div>
        {% endfor %}
    </div>
  {% endif %}

  <!-- Course Header -->
  <div class="bg-white rounded-lg shadow-md overflow-hidden mb-8">
      <div class="relative">
          <div class="h-64 bg-gradient-to-r from-indigo-500 to-purple-600">
              {% if course.image %}
              <img src="{{ course.image.url }}" alt="{{ course.title }}" class="w-full h-full object-cover opacity-50">
              {% endif %}
          </div>
          <div class="absolute inset-0 flex items-center">
              <div class="container mx-auto px-6">
                  <h1 class="text-3xl md:text-4xl font-bold text-white mb-2">{{ course.title }}</h1>
                  <div class="flex flex-wrap items-center text-white">
                      <span class="bg-white bg-opacity-20 rounded-full px-3 py-1 text-sm font-medium mr-3 mb-2">
                          {{ course.category.name }}
                      </span>
                      <span class="bg-white bg-opacity-20 rounded-full px-3 py-1 text-sm font-medium mr-3 mb-2">
                          {{ course.get_course_level_display }}
                      </span>
                      <span class="bg-white bg-opacity-20 rounded-full px-3 py-1 text-sm font-medium mr-3 mb-2">
                          {{ course.get_course_type_display }}
                      </span>
                      
                      {% if course.deadline %}
                      <span class="bg-white bg-opacity-20 rounded-full px-3 py-1 text-sm font-medium mr-3 mb-2">
                          {% if deadline_passed %}
                          <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 inline-block mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                          </svg>
                          Enrollment closed
                          {% else %}
                          <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 inline-block mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                          </svg>
                          {{ days_remaining }} days left
                          {% endif %}
                      </span>
                      {% endif %}
                  </div>
                  
                  {% if is_enrolled and course_progress %}
                  <div class="mt-4">
                      <div class="bg-white bg-opacity-20 rounded-lg p-2 max-w-md">
                          <div class="flex justify-between items-center mb-1">
                              <span class="text-sm font-medium">Your Progress</span>
                              <span class="text-sm">{{ progress_percentage|floatformat:0 }}%</span>
                          </div>
                          <div class="w-full bg-white bg-opacity-30 rounded-full h-2.5">
                              <div class="bg-green-500 h-2.5 rounded-full" style="width: {{ progress_percentage }}%"></div>
                          </div>
<div class="text-xs mt-1">
    {{ completed_progress_topics }} of {{ total_progress_topics }} required topics completed
</div>
                      </div>
                  </div>
                  {% endif %}
              </div>
          </div>
      </div>
      
      <!-- Course Info Tabs -->
      <div class="border-b">
          <nav class="flex overflow-x-auto">
              <button id="overview-tab" class="px-4 py-3 border-b-2 border-indigo-600 text-indigo-600 font-medium whitespace-nowrap">Overview</button>
              <button id="curriculum-tab" class="px-4 py-3 text-gray-500 hover:text-indigo-600 whitespace-nowrap">Curriculum</button>
              <button id="reviews-tab" class="px-4 py-3 text-gray-500 hover:text-indigo-600 whitespace-nowrap">Reviews</button>
          </nav>
      </div>
      
      <!-- Course Overview Section -->
      <div id="overview-section" class="p-6">
          <div class="grid md:grid-cols-3 gap-8">
              <div class="md:col-span-2">
                  <h2 class="text-2xl font-semibold mb-4">About This Course</h2>
                  <div class="prose max-w-none">
                      <p>{{ course.description }}</p>
                  </div>
                  
                  <h2 class="text-2xl font-semibold mt-8 mb-4">What You'll Learn</h2>
                  <ul class="grid md:grid-cols-2 gap-3">
                      {% for section in sections %}
                      <li class="flex items-start">
                          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-indigo-600 mr-2 mt-0.5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                          </svg>
                          <span>{{ section.title }}</span>
                      </li>
                      {% endfor %}
                  </ul>
              </div>
              
              <div>
                  <div class="bg-gray-50 p-6 rounded-lg sticky top-4">
                      <!-- Only show price for non-enrolled users -->
                      {% if not is_enrolled %}
                      <div class="text-center mb-6">
                          {% if course.price == 0 %}
                          <span class="text-3xl font-bold text-green-600">Free</span>
                          {% else %}
                          <span class="text-3xl font-bold">${{ course.price }}</span>
                          {% endif %}
                      </div>
                      {% endif %}
                      
                      <ul class="space-y-3 mb-6">
                          <li class="flex items-center">
                              <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-indigo-600 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                              </svg>
                              <span>{{ sections|length }} sections</span>
                          </li>
                          <li class="flex items-center">
                              <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-indigo-600 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z" />
                              </svg>
                              <span>{{ total_topics_count }} lessons</span>
                          </li>
                          <!-- Removed 'Downloadable resources' -->
                          <li class="flex items-center">
                              <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-indigo-600 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                              </svg>
                              <span>Certificate of completion</span>
                          </li>
                          <!-- Removed 'Full lifetime access' -->
                          
                          {% if course.deadline %}
                          <li class="flex items-center">
                              <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-indigo-600 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                              </svg>
                              <span>
                                  {% if deadline_passed %}
                                  <span class="text-red-600">Enrollment closed</span>
                                  {% else %}
                                  <span>Enrollment closes in {{ days_remaining }} days</span>
                                  {% endif %}
                              </span>
                          </li>
                          {% endif %}
                      </ul>
                      
                      {% if not is_enrolled %}
                            {% if course.price == 0 %}
                                <!-- Free course enrollment button -->
                                <div class="mt-6">
                                    <a href="{% url 'enroll_free_course' course.id %}" 
                                    class="inline-block w-full px-6 py-3 bg-green-600 text-white font-semibold rounded-lg shadow-md hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-opacity-50 transition-colors text-center">
                                        Enroll Now (Free)
                                    </a>
                                    <p class="mt-2 text-sm text-gray-600">This is a free course - no payment required!</p>
                                </div>
                            {% else %}
                                <!-- Paid course enrollment button -->
                                <div class="mt-6">
                                    <a href="{% url 'initiate_payment' course.id %}" 
                                    class="inline-block w-full px-6 py-3 bg-indigo-600 text-white font-semibold rounded-lg shadow-md hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-opacity-50 transition-colors text-center">
                                        Enroll Now
                                    </a>
                                    <p class="mt-2 text-sm text-gray-600">Secure payment via ZainCash</p>
                                </div>
                            {% endif %}
                        {% else %}
                            <!-- Already enrolled - Study button -->
                            <div class="mt-6">
                                <a href="{% url 'study_course' course.id %}" 
                                class="inline-block w-full px-6 py-3 bg-green-600 text-white font-semibold rounded-lg shadow-md hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-opacity-50 transition-colors text-center">
                                    Study Course
                                </a>
                                <p class="mt-2 text-sm text-gray-600">You're already enrolled in this course</p>
                            </div>
                        {% endif %}
                      
                      {% if not is_enrolled and course.price > 0 %}
                      <p class="text-center text-sm text-gray-500 mt-4">30-Day Money-Back Guarantee</p>
                      {% endif %}
                  </div>
              </div>
          </div>
      </div>
      
      <!-- Course Curriculum Section (Hidden by default) -->
      <div id="curriculum-section" class="p-6 hidden">
          <h2 class="text-2xl font-semibold mb-6">Course Curriculum</h2>
          
          <div class="space-y-4">
              {% for section in sections %}
              <div class="border rounded-lg overflow-hidden">
                  <div class="bg-gray-50 p-4 flex justify-between items-center cursor-pointer section-header">
                      <h3 class="font-medium">{{ section.title }}</h3>
                      <div class="flex items-center">
                          {% if is_enrolled and section_progress %}
                              {% for sp_id, sp_data in section_progress.items %}
                                  {% if sp_id == section.id %}
                                      {% if sp_data.completed %}
                                      <span class="text-sm text-green-600 mr-2">
                                          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 inline" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                                          </svg>
                                          Completed
                                      </span>
                                      {% elif sp_data.is_active %}
                                      <span class="text-sm text-indigo-600 mr-2">{{ sp_data.progress }}%</span>
                                      {% else %}
                                      <span class="text-sm text-gray-400 mr-2">
                                          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 inline" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" />
                                          </svg>
                                          Locked
                                      </span>
                                      {% endif %}
                                  {% endif %}
                              {% endfor %}
                          {% endif %}
                          <span class="text-sm text-gray-500 mr-2">{{ section.topics.count }} lessons</span>
                          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-500 transform transition-transform" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                          </svg>
                      </div>
                  </div>
                  
                  <div class="p-4 hidden section-content">
                      <ul class="space-y-2">
                          {% for topic in section.topics.all %}
                          <li class="flex justify-between items-center p-2 hover:bg-gray-50 rounded">
                              <div class="flex items-center">
                                  {% if topic.content_type == 'video' %}
                                  <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-indigo-600 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z" />
                                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                                  </svg>
                                  {% elif topic.content_type == 'article' %}
                                  <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-indigo-600 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                                  </svg>
                                  {% elif topic.content_type == 'quiz' %}
                                  <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-indigo-600 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                                  </svg>
                                  {% endif %}
                                  <span>{{ topic.title }}</span>
                              </div>
                              
                              <!-- Removed "Start" links, only showing status icons -->
                              {% if is_enrolled and topic_progress %}
                                  {% with topic_status=None %}
                                      {% for tp_id, tp_data in topic_progress.items %}
                                          {% if tp_id == topic.id %}
                                              {% if tp_data.completed %}
                                              <span class="text-green-600">
                                                  <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 inline" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                                                  </svg>
                                              </span>
                                              {% elif tp_data.is_active %}
                                              <span class="text-indigo-600">
                                                  <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 inline" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                                                  </svg>
                                              </span>
                                              {% else %}
                                              <span class="text-gray-400">
                                                  <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 inline" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" />
                                                  </svg>
                                              </span>
                                              {% endif %}
                                          {% endif %}
                                      {% endfor %}
                                  {% endwith %}
                              {% else %}
                              <span class="text-xs px-2 py-1 bg-gray-100 text-gray-600 rounded-full">Preview</span>
                              {% endif %}
                          </li>
                          {% endfor %}
                      </ul>
                  </div>
              </div>
              {% endfor %}
          </div>
      </div>
      
      <!-- Course Reviews Section (Hidden by default) -->
      <!-- Updated with actual review functionality -->
      <div id="reviews-section" class="p-6 hidden">
          <h2 class="text-2xl font-semibold mb-6">Student Reviews</h2>
          
          <div class="mb-8">
              <div class="flex items-center mb-4">
                  <div class="flex items-center mr-4">
                      <span class="text-3xl font-bold mr-2">{{ avg_rating|default:"0"|floatformat:1 }}</span>
                      <div>
                          <div class="flex text-yellow-400">
                              {% for i in "12345" %}
                                  {% if forloop.counter <= avg_rating|default:0|floatformat:"0" %}
                                      <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                          <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z" />
                                      </svg>
                                  {% else %}
                                      <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-300" viewBox="0 0 20 20" fill="currentColor">
                                          <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z" />
                                      </svg>
                                  {% endif %}
                              {% endfor %}
                          </div>
                          <p class="text-sm text-gray-500">Based on {{ reviews.count|default:"0" }} reviews</p>
                      </div>
                  </div>
              </div>
              
              <!-- Rating distribution - Using star_counts from view -->
              <div class="space-y-1">
                  {% for i in "54321" %}
                  <div class="flex items-center">
                      <span class="text-sm w-12">{{ i }} star{% if i != '1' %}s{% endif %}</span>
                      <div class="flex-grow h-2 mx-2 bg-gray-200 rounded-full">
                          {% with i_value=i|add:"0" %}
                              {% with star_count=star_counts|get_item:i_value %}
                                  {% if total_reviews > 0 %}
                                      <div class="h-2 bg-yellow-400 rounded-full" style="width: {% widthratio star_count total_reviews 100 %}%;"></div>
                                  {% else %}
                                      <div class="h-2 bg-yellow-400 rounded-full" style="width: 0%;"></div>
                                  {% endif %}
                              {% endwith %}
                          {% endwith %}
                      </div>
                      <span class="text-sm w-12 text-right">
                          {% with i_value=i|add:"0" %}
                              {% with star_count=star_counts|get_item:i_value %}
                                  {% if total_reviews > 0 %}
                                      {% widthratio star_count total_reviews 100 %}%
                                  {% else %}
                                      0%
                                  {% endif %}
                              {% endwith %}
                          {% endwith %}
                      </span>
                  </div>
                  {% endfor %}
              </div>
          </div>
          
          <!-- Reviews list -->
          <!-- Reviews list -->
<div class="space-y-6 mb-8">
    {% if reviews %}
        {% for review in reviews %}
        <div class="border-b pb-6">
            <div class="flex items-center mb-2">
                <div class="w-10 h-10 rounded-full mr-3 overflow-hidden">
                    {% if review.user.his_profile.profile_photo %}
                        <img src="{{ review.user.his_profile.profile_photo.url }}" alt="{{ review.user.username }}" class="w-full h-full object-cover">
                    {% else %}
                        <div class="w-full h-full bg-gray-200 flex items-center justify-center">
                            <span class="text-gray-600 font-medium">{{ review.user.username|slice:":1"|upper }}</span>
                        </div>
                    {% endif %}
                </div>
                <div>
                    <h4 class="font-semibold">{{ review.user.get_full_name|default:review.user.username }}</h4>
                    <div class="flex items-center">
                        <div class="flex text-yellow-400">
                            {% for i in "12345" %}
                                {% if forloop.counter <= review.rating %}
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
                                        <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z" />
                                    </svg>
                                {% else %}
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-gray-300" viewBox="0 0 20 20" fill="currentColor">
                                        <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z" />
                                    </svg>
                                {% endif %}
                            {% endfor %}
                        </div>
                        <span class="text-sm text-gray-500 ml-2">{{ review.created_at|date:"F j, Y" }}</span>
                    </div>
                </div>
            </div>
            <p class="text-gray-700">{{ review.comment }}</p>
        </div>
        {% endfor %}
    {% else %}
        <div class="text-center p-8 bg-gray-50 rounded-lg">
            <p class="text-gray-600">No reviews yet for this course.</p>
        </div>
    {% endif %}
</div>
          
          <!-- Write a review section -->
          <div class="mt-8">
              <h3 class="text-xl font-semibold mb-4">Write a Review</h3>
              
              {% if is_enrolled %}
                  <form method="post" action="{% url 'submit_review' course.id %}" class="bg-gray-50 p-6 rounded-lg">
                      {% csrf_token %}
                      <div class="mb-4">
                          <label class="block text-gray-700 font-medium mb-2">Rating</label>
                          <div class="flex text-gray-400 rating-stars">
                              {% for i in "12345" %}
                                  <button type="button" class="h-8 w-8 mr-1 focus:outline-none" data-rating="{{ forloop.counter }}">
                                      <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 {% if user_review and user_review.rating >= forloop.counter %}text-yellow-400{% endif %}" viewBox="0 0 20 20" fill="currentColor">
                                          <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z" />
                                      </svg>
                                  </button>
                              {% endfor %}
                          </div>
                          <input type="hidden" name="rating" id="rating" value="{% if user_review %}{{ user_review.rating }}{% else %}5{% endif %}">
                      </div>
                      
                      <div class="mb-4">
                          <label for="comment" class="block text-gray-700 font-medium mb-2">Your Review</label>
                          <textarea id="comment" name="comment" rows="4" required
                                    class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">{% if user_review %}{{ user_review.comment }}{% endif %}</textarea>
                      </div>
                      
                      <button type="submit" class="bg-indigo-600 hover:bg-indigo-700 text-white font-medium py-2 px-4 rounded-lg transition">
                          {% if user_review %}Update Review{% else %}Submit Review{% endif %}
                      </button>
                  </form>
              {% else %}
              <div class="bg-gray-50 p-6 rounded-lg text-center">
                  <p class="text-gray-600 mb-4">You need to enroll in this course to write a review.</p>
                  {% if user.is_authenticated %}
                      {% if course.price == 0 %}
                          <a href="{% url 'enroll_free_course' course.id %}" class="inline-block bg-green-600 hover:bg-green-700 text-white font-medium py-2 px-4 rounded-lg transition">
                              Enroll Now (Free)
                          </a>
                      {% else %}
                          <a href="{% url 'initiate_payment' course.id %}" class="inline-block bg-indigo-600 hover:bg-indigo-700 text-white font-medium py-2 px-4 rounded-lg transition">
                              Enroll Now
                          </a>
                      {% endif %}
                  {% else %}
                      <a href="{% url 'login' %}?next={% url 'course_detail' course.id %}" class="inline-block bg-indigo-600 hover:bg-indigo-700 text-white font-medium py-2 px-4 rounded-lg transition">
                          Log in to Enroll
                      </a>
                  {% endif %}
              </div>
              {% endif %}
          </div>
      </div>
  </div>
  
  <!-- More courses from the same category -->
  <div class="mt-12">
      <h2 class="text-2xl font-bold mb-6">More {{ course.category.name }} Courses</h2>
      
      <div class="grid md:grid-cols-2 lg:grid-cols-3 gap-8">
          {% for related_course in related_courses %}
          <div class="bg-white rounded-lg shadow-md overflow-hidden">
              <div class="h-48 overflow-hidden">
                  {% if related_course.image %}
                      <img src="{{ related_course.image.url }}" alt="{{ related_course.title }}" class="w-full h-full object-cover">
                  {% else %}
                      <div class="w-full h-full bg-gradient-to-r from-indigo-500 to-purple-600 flex items-center justify-center">
                          <span class="text-white font-medium">{{ related_course.title }}</span>
                      </div>
                  {% endif %}
              </div>
              <div class="p-6">
                  <div class="flex justify-between items-center mb-2">
                      <span class="text-sm font-medium px-2 py-1 bg-indigo-100 text-indigo-800 rounded">{{ related_course.get_course_level_display }}</span>
                      {% if related_course.price == 0 %}
                          <span class="text-green-600 font-medium">Free</span>
                      {% else %}
                          <span class="text-gray-600">${{ related_course.price }}</span>
                      {% endif %}
                  </div>
                  <h3 class="text-xl font-semibold mb-2">{{ related_course.title }}</h3>
                  <p class="text-gray-600 mb-4 line-clamp-2">{{ related_course.description }}</p>
                  <a href="{% url 'course_detail' related_course.id %}" class="block text-center bg-indigo-600 hover:bg-indigo-700 text-white font-medium py-2 px-4 rounded transition">
                      View Course
                  </a>
              </div>
          </div>
          {% empty %}
          <div class="col-span-full text-center py-8">
              <p class="text-gray-600">No other courses in this category yet.</p>
          </div>
          {% endfor %}
      </div>
  </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', function() {
      // Tab navigation
      const overviewTab = document.getElementById('overview-tab');
      const curriculumTab = document.getElementById('curriculum-tab');
      const reviewsTab = document.getElementById('reviews-tab');
      
      const overviewSection = document.getElementById('overview-section');
      const curriculumSection = document.getElementById('curriculum-section');
      const reviewsSection = document.getElementById('reviews-section');
      
      overviewTab.addEventListener('click', () => {
          // Update active tab
          overviewTab.classList.add('border-indigo-600', 'text-indigo-600');
          overviewTab.classList.remove('text-gray-500');
          curriculumTab.classList.remove('border-indigo-600', 'text-indigo-600');
          curriculumTab.classList.add('text-gray-500');
          reviewsTab.classList.remove('border-indigo-600', 'text-indigo-600');
          reviewsTab.classList.add('text-gray-500');
          
          // Show corresponding section
          overviewSection.classList.remove('hidden');
          curriculumSection.classList.add('hidden');
          reviewsSection.classList.add('hidden');
      });
      
      curriculumTab.addEventListener('click', () => {
          // Update active tab
          curriculumTab.classList.add('border-indigo-600', 'text-indigo-600');
          curriculumTab.classList.remove('text-gray-500');
          overviewTab.classList.remove('border-indigo-600', 'text-indigo-600');
          overviewTab.classList.add('text-gray-500');
          reviewsTab.classList.remove('border-indigo-600', 'text-indigo-600');
          reviewsTab.classList.add('text-gray-500');
          
          // Show corresponding section
          curriculumSection.classList.remove('hidden');
          overviewSection.classList.add('hidden');
          reviewsSection.classList.add('hidden');
      });
      
      reviewsTab.addEventListener('click', () => {
          // Update active tab
          reviewsTab.classList.add('border-indigo-600', 'text-indigo-600');
          reviewsTab.classList.remove('text-gray-500');
          overviewTab.classList.remove('border-indigo-600', 'text-indigo-600');
          overviewTab.classList.add('text-gray-500');
          curriculumTab.classList.remove('border-indigo-600', 'text-indigo-600');
          curriculumTab.classList.add('text-gray-500');
          
          // Show corresponding section
          reviewsSection.classList.remove('hidden');
          overviewSection.classList.add('hidden');
          curriculumSection.classList.add('hidden');
      });
      
      // Curriculum section toggles
      const sectionHeaders = document.querySelectorAll('.section-header');
      
      sectionHeaders.forEach(header => {
          header.addEventListener('click', () => {
              const content = header.parentElement.querySelector('.section-content');
              content.classList.toggle('hidden');
              
              const arrow = header.querySelector('svg');
              arrow.classList.toggle('rotate-180');
          });
      });
      
      // Star rating system for review form
      const ratingStars = document.querySelectorAll('.rating-stars button');
      const ratingInput = document.getElementById('rating');
      
      if (ratingStars.length > 0 && ratingInput) {
          ratingStars.forEach(star => {
              star.addEventListener('click', () => {
                  const rating = star.getAttribute('data-rating');
                  ratingInput.value = rating;
                  
                  // Update star colors
                  ratingStars.forEach(s => {
                      const starRating = s.getAttribute('data-rating');
                      const starIcon = s.querySelector('svg');
                      
                      if (starRating <= rating) {
                          starIcon.classList.add('text-yellow-400');
                          starIcon.classList.remove('text-gray-300');
                      } else {
                          starIcon.classList.remove('text-yellow-400');
                          starIcon.classList.add('text-gray-300');
                      }
                  });
              });
              
              // Hover effect
              star.addEventListener('mouseenter', () => {
                  const rating = star.getAttribute('data-rating');
                  
                  ratingStars.forEach(s => {
                      const starRating = s.getAttribute('data-rating');
                      const starIcon = s.querySelector('svg');
                      
                      if (starRating <= rating) {
                          starIcon.classList.add('text-yellow-400');
                          starIcon.classList.remove('text-gray-300');
                      } else {
                          starIcon.classList.remove('text-yellow-400');
                          starIcon.classList.add('text-gray-300');
                      }
                  });
              });
          });
          
          // Handle mouseout - reset to selected rating
          const starsContainer = document.querySelector('.rating-stars');
          if (starsContainer) {
              starsContainer.addEventListener('mouseleave', () => {
                  const selectedRating = ratingInput.value;
                  
                  ratingStars.forEach(s => {
                      const starRating = s.getAttribute('data-rating');
                      const starIcon = s.querySelector('svg');
                      
                      if (starRating <= selectedRating) {
                          starIcon.classList.add('text-yellow-400');
                          starIcon.classList.remove('text-gray-300');
                      } else {
                          starIcon.classList.remove('text-yellow-400');
                          starIcon.classList.add('text-gray-300');
                      }
                  });
              });
          }
      }
  });
</script>
{% endblock %}