{% extends "base.html" %}

{% block title %}Payment - {{ course.title }} - LearnHub{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto py-8">
    <div class="bg-white rounded-lg shadow-md overflow-hidden">
        <div class="bg-indigo-600 text-white p-6">
            <h1 class="text-2xl font-bold">Enroll in Course</h1>
            <p class="text-indigo-200">Complete your payment to get access to this course</p>
        </div>
        
        <div class="p-6">
            <div class="mb-8 flex items-center border-b pb-4">
                <div class="w-24 h-24 rounded-lg overflow-hidden mr-4 flex-shrink-0">
                    <img src="{{ course.image.url }}" alt="{{ course.title }}" class="w-full h-full object-cover">
                </div>
                <div>
                    <h2 class="text-xl font-semibold mb-1">{{ course.title }}</h2>
                    <div class="flex items-center text-sm mb-2">
                        <span class="bg-indigo-100 text-indigo-800 px-2 py-1 rounded mr-2">{{ course.get_course_level_display }}</span>
                        <span class="text-gray-500">{{ course.category.name }}</span>
                    </div>
                    <p class="text-gray-600">{{ course.description|truncatewords:20 }}</p>
                </div>
            </div>
            
            <div class="mb-8">
                <h3 class="text-lg font-medium mb-4">Payment Summary</h3>
                <div class="bg-gray-50 p-4 rounded-lg">
                    <div class="flex justify-between py-2 border-b">
                        <span>Course Price</span>
                        <span class="font-medium">${{ course.price }}</span>
                    </div>
                    <div class="flex justify-between py-2 text-lg font-semibold text-indigo-700 mt-2">
                        <span>Total</span>
                        <span>${{ course.price }}</span>
                    </div>
                </div>
            </div>
            
            <div class="mb-8">
                <h3 class="text-lg font-medium mb-4">Payment Method</h3>
                <div class="bg-gray-50 p-4 rounded-lg">
                    <div class="flex items-center mb-4">
                        <input type="radio" id="zaincash" name="payment_method" checked 
                               class="h-4 w-4 text-indigo-600 focus:ring-indigo-500">
                        <label for="zaincash" class="ml-3 block text-sm font-medium text-gray-700">
                            Zain Cash
                        </label>
                    </div>
                    
                    <div id="zaincash-form" class="mt-4">
                        <div class="mb-4">
                            <label for="phone_number" class="block text-sm font-medium text-gray-700 mb-1">
                                Zain Cash Phone Number
                            </label>
                            <input type="tel" name="phone_number" id="phone_number" 
                                   placeholder="e.g. 07xxxxxxxx" required
                                   class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
                            <p class="text-sm text-gray-500 mt-1">Enter the phone number registered with your Zain Cash account</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="flex justify-end space-x-4">
                <a href="{% url 'course_detail' course.id %}" class="px-6 py-2 border border-gray-300 rounded-md text-gray-700 bg-white hover:bg-gray-50">
                    Cancel
                </a>
                <button id="proceed-payment" class="px-6 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700">
                    Proceed to Payment
                </button>
            </div>
            
            <!-- Payment Processing Overlay (hidden by default) -->
            <div id="payment-overlay" class="hidden fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center z-50">
                <div class="bg-white p-8 rounded-lg shadow-lg max-w-md w-full">
                    <div class="text-center">
                        <div class="animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-indigo-500 mx-auto mb-4"></div>
                        <h3 class="text-lg font-medium text-gray-900 mb-2">Processing Payment</h3>
                        <p class="text-gray-500">Please wait while we process your payment with Zain Cash...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const proceedButton = document.getElementById('proceed-payment');
        const phoneInput = document.getElementById('phone_number');
        const paymentOverlay = document.getElementById('payment-overlay');
        
        proceedButton.addEventListener('click', function() {
            // Basic validation
            if (!phoneInput.value.trim()) {
                alert('Please enter your Zain Cash phone number');
                return;
            }
            
            // Show loading overlay
            paymentOverlay.classList.remove('hidden');
            
            // Process payment with ZainCash
            fetch('{% url "process_payment" course.id %}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: JSON.stringify({
                    phone_number: phoneInput.value.trim(),
                    transaction_id: '{{ transaction_id }}'
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    // Redirect to ZainCash or success page
                    window.location.href = data.redirect_url;
                } else {
                    // Hide overlay and show error
                    paymentOverlay.classList.add('hidden');
                    alert('Payment failed: ' + data.message);
                }
            })
            .catch(error => {
                // Hide overlay and show error
                paymentOverlay.classList.add('hidden');
                alert('An error occurred. Please try again later.');
                console.error('Error:', error);
            });
        });
    });
</script>
{% endblock %}